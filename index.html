<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <title>Kalender Dashboard</title>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;700;900&display=swap');
        :root {
            --color-bg: #111827;
            --color-text-dark: #1f2937;
            --color-text-light: #f9fafb;
        }
        html, body {
            margin: 0; padding: 0; width: 100%; height: 100%;
            overflow: hidden; position: fixed;
        }
        body {
            font-family: 'Inter', -apple-system, sans-serif;
            background-color: var(--color-bg);
            color: var(--color-text-light);
            display: flex; flex-direction: column;
        }
        #calendar-dashboard {
            padding: 24px; display: grid;
            grid-template-columns: 1fr; /* Immer nur eine Spalte, für eine klare Tages-Struktur */
            gap: 12px; flex-grow: 1; overflow-y: auto; -webkit-overflow-scrolling: touch;
        }
        .event-card {
            color: var(--color-text-dark); padding: 16px; border-radius: 16px;
            display: flex; flex-direction: column;
            box-shadow: 0 4px 15px rgba(0,0,0,0.2);
        }
        .event-card .content { flex-grow: 1; }
        .event-card h2 {
            margin: 0; font-size: 20px; font-weight: 700; word-break: break-word; line-height: 1.3;
        }
        .calendar-source {
            font-weight: 700; font-size: 12px; margin: 8px 0 0 0;
            padding: 4px 8px; background-color: rgba(0,0,0,0.1);
            border-radius: 6px; display: inline-block;
        }
        .event-details {
            text-align: right; margin-top: 12px; /* Weniger Abstand */
        }
        .event-details .time {
            font-size: 16px; /* Deutlich kleiner */ font-weight: 400;
        }
        .event-details .date {
            font-size: 24px; /* Größer als die Zeit */ font-weight: 900;
        }

        /* NEU: Styling für die leeren Tage */
        .empty-day-card {
            background-color: #1f2937; /* Dunklerer Hintergrund */
            color: #9ca3af; /* Gedämpftere Textfarbe */
            padding: 8px 16px; /* Sehr schmal */
            border-radius: 12px;
            text-align: center;
            font-weight: 700;
            font-size: 14px;
        }

        /* Desktop-Anpassungen für eine Grid-Ansicht */
        @media (min-width: 768px) {
            #calendar-dashboard {
                grid-template-columns: repeat(auto-fit, minmax(350px, 1fr));
                gap: 24px; padding: 24px;
            }
            .event-card { padding: 24px; border-radius: 24px; }
            .event-card h2 { font-size: 24px; }
            .event-details .time { font-size: 18px; }
            .event-details .date { font-size: 32px; }
        }
    </style>
</head>
<body>
    <div id="calendar-dashboard">
        <h2>Lade Kalenderdaten...</h2>
    </div>
    <script>
        const dashboard = document.getElementById('calendar-dashboard');
        const colorMap = {
            'M&M': '#f4da63',
            'Maria': '#d3d3d3',
            'MK Solo': '#6dada9',
            'Bodo Banali': '#6dada9',
            'default': '#e5e7eb'
        };
        function getContrastColor(hexColor) { /* ... (Diese Funktion bleibt unverändert) ... */ }

        async function fetchAndDisplayEvents() {
            try {
                const response = await fetch('https://mkscal.ikeakatalog.workers.dev/');
                if (!response.ok) throw new Error('Netzwerkfehler');
                const events = await response.json();
                dashboard.innerHTML = ''; 

                // --- NEUE LOGIK ZUR ANZEIGE ALLER TAGE ---

                // 1. Gruppiere die abgerufenen Termine nach ihrem Datum
                const eventsByDate = {};
                events.forEach(event => {
                    const eventDate = new Date(event.start.dateTime || event.start.date);
                    const dateKey = eventDate.toISOString().split('T')[0]; // z.B. "2025-10-22"
                    if (!eventsByDate[dateKey]) {
                        eventsByDate[dateKey] = [];
                    }
                    eventsByDate[dateKey].push(event);
                });

                // 2. Gehe die nächsten 30 Tage durch und zeige für jeden Tag etwas an
                const today = new Date();
                for (let i = 0; i < 30; i++) {
                    const currentDay = new Date();
                    currentDay.setDate(today.getDate() + i);
                    const dateKey = currentDay.toISOString().split('T')[0];
                    
                    // Prüfe, ob es für diesen Tag Termine gibt
                    if (eventsByDate[dateKey]) {
                        // Wenn ja, zeige alle Termine für diesen Tag an
                        eventsByDate[dateKey].forEach(event => {
                            const card = document.createElement('div');
                            card.className = 'event-card';
                            const bgColor = colorMap[event.calendarName] || colorMap['default'];
                            card.style.backgroundColor = bgColor;
                            const textColor = getContrastColor(bgColor);
                            card.style.color = textColor;
                            
                            const startDate = new Date(event.start.dateTime || event.start.date);
                            // NEU: Abgekürztes Datumsformat
                            const dateStringShort = startDate.toLocaleDateString('de-DE', { weekday: 'short', day: 'numeric', month: 'numeric' });
                            const timeString = event.start.dateTime 
                                ? startDate.toLocaleTimeString('de-DE', { hour: '2-digit', minute: '2-digit' }) + ' Uhr'
                                : 'Ganztägig';
                            
                            // NEU: HTML-Struktur mit getauschtem Datum/Uhrzeit
                            card.innerHTML = `
                                <div class="content">
                                    <h2>${event.summary || '(Kein Titel)'}</h2>
                                    <p class="calendar-source">${event.calendarName}</p>
                                </div>
                                <div class="event-details">
                                    <div class="date">${dateStringShort}</div>
                                    <div class="time">${timeString}</div>
                                </div>
                            `;
                            dashboard.appendChild(card);
                        });
                    } else {
                        // Wenn nein, zeige den schmalen "leerer Tag"-Balken an
                        const emptyCard = document.createElement('div');
                        emptyCard.className = 'empty-day-card';
                        emptyCard.textContent = currentDay.toLocaleDateString('de-DE', { weekday: 'long', day: 'numeric', month: 'long' });
                        dashboard.appendChild(emptyCard);
                    }
                }

            } catch (error) {
                dashboard.innerHTML = `<h2>Fehler: Daten konnten nicht geladen werden.</h2><p>Bitte prüfen Sie die Freigabe-Einstellungen Ihrer Kalender.</p>`;
            }
        }
        
        // Helfer-Funktion für die Textfarbe (unverändert)
        function getContrastColor(hexColor) {
            if (!hexColor) return '#1f2937';
            const r = parseInt(hexColor.substr(1, 2), 16);
            const g = parseInt(hexColor.substr(3, 2), 16);
            const b = parseInt(hexColor.substr(5, 2), 16);
            const luminance = (0.299 * r + 0.587 * g + 0.114 * b) / 255;
            return luminance > 0.6 ? '#1f2937' : '#f9fafb';
        }

        fetchAndDisplayEvents();
        setInterval(fetchAndDisplayEvents, 60000);
    </script>
</body>
</html>
