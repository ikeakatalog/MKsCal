<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <title>Dashboard</title>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;700;900&display=swap');
        :root { --color-bg: #111827; --color-text-dark: #1f2937; --color-text-light: #f9fafb; }
        html, body { margin: 0; padding: 0; width: 100%; height: 100%; overflow: hidden; position: fixed; }
        body { font-family: 'Inter', -apple-system, sans-serif; background-color: var(--color-bg); color: var(--color-text-light); display: flex; flex-direction: column; }
        .transit-widget {
            padding: 12px 24px; background-color: #1f2937; flex-shrink: 0;
            box-shadow: 0 4px 10px rgba(0,0,0,0.3); border-bottom: 1px solid #374151;
        }
        .transit-widget h3 { margin: 0 0 10px 0; font-size: 14px; font-weight: 700; color: #d1d5db; }
        .departures-list { display: flex; gap: 12px; overflow-x: auto; padding-bottom: 10px; -webkit-overflow-scrolling: touch; }
        .departure { background-color: #374151; padding: 6px 10px; border-radius: 8px; text-align: center; min-width: 80px; }
        .departure .line { font-weight: 900; font-size: 18px; }
        .departure .time { font-size: 16px; font-weight: 700; color: #f9fafb; }
        .departure .delay { font-size: 11px; font-weight: 700; color: #fecaca; }
        .departure .direction {
            font-size: 14px; /* GRÖSSER */
            font-weight: 700; /* FETT */
            color: #9ca3af; white-space: nowrap; overflow: hidden;
            text-overflow: ellipsis; max-width: 80px; margin-top: 4px;
        }
        #calendar-dashboard {
            padding: 12px 0; /* Oben/unten Padding, aber seitlich bis zum Rand */
            display: grid; grid-template-columns: 1fr; 
            gap: 12px; /* Abstand zwischen den separaten Karten */
            flex-grow: 1; overflow-y: auto; -webkit-overflow-scrolling: touch;
        }
        .event-card, .empty-day-card {
            padding: 12px 16px; /* SCHMALER */
            border-radius: 24px; /* STARK ABRUNDEN */
            margin: 0 12px; /* Seitlicher Abstand, damit Karten nicht am Rand kleben */
            display: flex; flex-direction: column;
        }
        .event-card { color: var(--color-text-dark); box-shadow: 0 4px 15px rgba(0,0,0,0.2); }
        .event-card .content { flex-grow: 1; }
        .event-card h2 { margin: 0; font-size: 18px; line-height: 1.2; } /* SCHMALER */
        .calendar-source { font-size: 11px; margin: 6px 0 0 0; padding: 3px 6px; }
        .event-details { text-align: right; margin-top: 8px; } /* SCHMALER */
        .event-details .time { font-size: 14px; font-weight: 400; }
        .event-details .date { font-size: 20px; font-weight: 900; } /* DATUM BLEIBT GROSS */
        
        .empty-day-card { background-color: #1f2937; color: #9ca3af; text-align: center; font-weight: 700; font-size: 14px; }
    </style>
</head>
<body>
    
    <div id="transit-widget-neukoelln" class="transit-widget">
        <h3>S+U Neukölln</h3>
        <div id="departures-neukoelln" class="departures-list"><p>Lade Abfahrten...</p></div>
    </div>
    
    <div id="transit-widget-sonnenallee" class="transit-widget">
        <h3>S Sonnenallee</h3>
        <div id="departures-sonnenallee" class="departures-list"><p>Lade Abfahrten...</p></div>
    </div>

    <div id="calendar-dashboard"><h2>Lade Kalenderdaten...</h2></div>

    <script>
        const CLOUDFLARE_WORKER_URL = 'https://mkscal.ikeakatalog.workers.dev/';
        const calendarDashboard = document.getElementById('calendar-dashboard');
        const colorMap = { 'M&M': '#f4da63', 'Maria': '#d3d3d3', 'MK Solo': '#6dada9', 'Bodo Banali': '#6dada9', 'default': '#e5e7eb' };

        async function fetchTransitData(stationId, listElementId) {
            const listElement = document.getElementById(listElementId);
            try {
                const response = await fetch(`${CLOUDFLARE_WORKER_URL}transit?id=${stationId}`);
                if (!response.ok) throw new Error('Netzwerkfehler');
                const departures = await response.json();
                
                listElement.innerHTML = '';
                if (!departures || departures.length === 0) {
                    listElement.innerHTML = '<p style="color: #9ca3af; font-size: 14px;">Keine Daten.</p>'; return;
                }
                departures.slice(0, 10).forEach(dep => {
                    const depElement = document.createElement('div');
                    depElement.className = 'departure';
                    const delayText = dep.delay > 0 ? `<div class="delay">+${dep.delay} min</div>` : '';
                    // KORREKTUR DER ZEIT: Der Browser rechnet jetzt die Zeitzone um
                    const timeString = dep.when ? new Date(dep.when).toLocaleTimeString('de-DE', { hour: '2-digit', minute: '2-digit' }) : '?';

                    depElement.innerHTML = `<div class="line">${dep.line}</div><div class="time">${timeString}</div>${delayText}<div class="direction">${dep.direction}</div>`;
                    listElement.appendChild(depElement);
                });
            } catch (error) { listElement.innerHTML = '<p>Fehler.</p>'; }
        }

        async function fetchAndDisplayEvents() {
            try {
                const response = await fetch(CLOUDFLARE_WORKER_URL);
                if (!response.ok) throw new Error('Netzwerkfehler');
                const events = await response.json();
                calendarDashboard.innerHTML = ''; const eventsByDate = {};
                events.forEach(event => { const d = new Date(event.start.dateTime || event.start.date); const key = new Date(d.getFullYear(), d.getMonth(), d.getDate()).toISOString(); if (!eventsByDate[key]) { eventsByDate[key] = []; } eventsByDate[key].push(event); });
                
                const today = new Date(); today.setHours(0,0,0,0);
                const tomorrow = new Date(today); tomorrow.setDate(today.getDate() + 1);

                for (let i = 0; i < 30; i++) {
                    const currentDay = new Date(today); currentDay.setDate(today.getDate() + i);
                    const dateKey = currentDay.toISOString();
                    
                    if (eventsByDate[dateKey]) {
                        eventsByDate[dateKey].forEach(event => {
                            const card = document.createElement('div'); card.className = 'event-card'; const bgColor = colorMap[event.calendarName] || colorMap['default']; card.style.backgroundColor = bgColor; const textColor = getContrastColor(bgColor); card.style.color = textColor; const startDate = new Date(event.start.dateTime || event.start.date);
                            let dateDisplayString;
                            if (currentDay.getTime() === today.getTime()) {
                                dateDisplayString = 'Heute';
                            } else if (currentDay.getTime() === tomorrow.getTime()) {
                                dateDisplayString = 'Morgen';
                            } else {
                                dateDisplayString = startDate.toLocaleDateString('de-DE', { weekday: 'short', day: 'numeric', month: 'numeric' });
                            }
                            const timeString = event.start.dateTime ? startDate.toLocaleTimeString('de-DE', { hour: '2-digit', minute: '2-digit' }) + ' Uhr' : 'Ganztägig';
                            card.innerHTML = `<div class="content"><h2>${event.summary || '(Kein Titel)'}</h2><p class="calendar-source">${event.calendarName}</p></div><div class="event-details"><div class="date">${dateDisplayString}</div><div class="time">${timeString}</div></div>`;
                            calendarDashboard.appendChild(card);
                        });
                    } else { const emptyCard = document.createElement('div'); emptyCard.className = 'empty-day-card'; emptyCard.textContent = currentDay.toLocaleDateString('de-DE', { weekday: 'long', day: 'numeric', month: 'long' }); calendarDashboard.appendChild(emptyCard); }
                }
            } catch (error) { calendarDashboard.innerHTML = `<h2>Fehler: Kalenderdaten konnten nicht geladen werden.</h2>`; }
        }
        function getContrastColor(hexColor) { if (!hexColor) return '#1f2937'; const r = parseInt(hexColor.substr(1, 2), 16); const g = parseInt(hexColor.substr(3, 2), 16); const b = parseInt(hexColor.substr(5, 2), 16); const luminance = (0.299 * r + 0.587 * g + 0.114 * b) / 255; return luminance > 0.6 ? '#1f2937' : '#f9fafb'; }

        fetchAndDisplayEvents();
        fetchTransitData('900078201', 'departures-neukoelln');
        fetchTransitData('900077106', 'departures-sonnenallee'); // ID für Sonnenallee

        setInterval(fetchAndDisplayEvents, 60000);
        setInterval(() => {
            fetchTransitData('900078201', 'departures-neukoelln');
            fetchTransitData('900077106', 'departures-sonnenallee');
        }, 30000);
    </script>
</body>
</html>
