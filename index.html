<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <title>Dashboard</title>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;700;900&display=swap');
        :root { --color-bg: #111827; --color-text-dark: #1f2937; --color-text-light: #f9fafb; }
        html, body { margin: 0; padding: 0; width: 100%; height: 100%; overflow: hidden; position: fixed; }
        body { font-family: 'Inter', -apple-system, sans-serif; background-color: var(--color-bg); color: var(--color-text-light); display: flex; flex-direction: column; }
        
        /* Das Widget wurde leicht angepasst, da die H3-Überschrift entfernt wurde */
        .transit-widget {
            padding: 12px 24px; /* Weniger Padding oben */
            background-color: #1f2937; flex-shrink: 0;
            box-shadow: 0 4px 10px rgba(0,0,0,0.3); border-bottom: 1px solid #374151;
        }
        .departures-list { display: flex; gap: 16px; overflow-x: auto; padding-bottom: 10px; -webkit-overflow-scrolling: touch; }
        .departure { background-color: #374151; padding: 8px 12px; border-radius: 8px; text-align: center; min-width: 90px; }
        .departure .line { font-weight: 900; font-size: 20px; }
        .departure .time { font-size: 18px; font-weight: 700; color: #f9fafb; }
        .departure .delay { font-size: 12px; font-weight: 700; color: #fecaca; }
        .departure .direction { font-size: 11px; color: #9ca3af; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; max-width: 90px; }
        
        #calendar-dashboard {
            padding: 24px; display: grid; grid-template-columns: 1fr;
            /* GEÄNDERT: Kein Abstand mehr zwischen den Kalender-Karten */
            gap: 0; 
            flex-grow: 1; overflow-y: auto; -webkit-overflow-scrolling: touch;
        }
        .event-card {
            color: var(--color-text-dark); padding: 16px; 
            /* GEÄNDERT: Die runden Ecken wurden entfernt für einen nahtlosen Look */
            border-radius: 0; 
            display: flex; flex-direction: column;
            /* GEÄNDERT: Eine feine Linie trennt die Termine */
            border-bottom: 1px solid #374151;
        }
        .event-card:first-child { border-top: 1px solid #374151; } /* Linie auch über dem ersten Element */

        .event-card .content { flex-grow: 1; }
        .event-card h2 { margin: 0; font-size: 20px; font-weight: 700; word-break: break-word; line-height: 1.3; }
        .calendar-source { font-weight: 700; font-size: 12px; margin: 8px 0 0 0; padding: 4px 8px; background-color: rgba(0,0,0,0.1); border-radius: 6px; display: inline-block; }
        .event-details { text-align: right; margin-top: 12px; }
        .event-details .time { font-size: 16px; font-weight: 400; }
        .event-details .date { font-size: 24px; font-weight: 900; }
        
        .empty-day-card {
            background-color: transparent; /* Passt sich dem Hintergrund an */
            color: #9ca3af; padding: 12px 16px;
            border-bottom: 1px solid #374151; /* Auch hier eine Trennlinie */
            text-align: center; font-weight: 700; font-size: 14px;
        }
        .empty-day-card:first-child { border-top: 1px solid #374151; }

        @media (min-width: 768px) {
            #calendar-dashboard { grid-template-columns: repeat(auto-fit, minmax(350px, 1fr)); gap: 24px; padding: 24px; }
            .event-card { padding: 24px; border-radius: 24px; border-bottom: none; } /* Auf dem Desktop wieder runde Karten */
            .event-card:first-child { border-top: none; }
            .empty-day-card { border-radius: 12px; border-bottom: none; background-color: #1f2937; }
            .empty-day-card:first-child { border-top: none; }
            .event-card h2 { font-size: 24px; }
            .event-details .time { font-size: 18px; }
            .event-details .date { font-size: 32px; }
        }
    </style>
</head>
<body>
    
    <!-- Die Überschriften wurden aus den Widgets entfernt -->
    <div id="transit-widget-neukoelln" class="transit-widget">
        <div id="departures-neukoelln" class="departures-list"><p>Lade S+U Neukölln...</p></div>
    </div>
    
    <div id="transit-widget-zeitzer" class="transit-widget">
        <div id="departures-zeitzer" class="departures-list"><p>Lade Zeitzer Str....</p></div>
    </div>

    <div id="calendar-dashboard"><h2>Lade Kalenderdaten...</h2></div>

    <script>
        const CLOUDFLARE_WORKER_URL = 'https://mkscal.ikeakatalog.workers.dev/';
        const calendarDashboard = document.getElementById('calendar-dashboard');
        const colorMap = { 'M&M': '#f4da63', 'Maria': '#d3d3d3', 'MK Solo': '#6dada9', 'Bodo Banali': '#6dada9', 'default': '#e5e7eb' };

        async function fetchTransitData(stationId, listElementId, stationName) {
            const listElement = document.getElementById(listElementId);
            try {
                const response = await fetch(`${CLOUDFLARE_WORKER_URL}transit?id=${stationId}`);
                if (!response.ok) throw new Error('Netzwerkfehler');
                const departures = await response.json();
                
                listElement.innerHTML = '';
                if (!departures || departures.length === 0) {
                    // Zeigt jetzt eine nützliche Info anstelle eines Fehlers
                    listElement.innerHTML = `<p style="color: #9ca3af; font-size: 14px; white-space: nowrap;">Für ${stationName} keine Abfahrten verfügbar.</p>`;
                    return;
                }
                departures.slice(0, 10).forEach(dep => {
                    const depElement = document.createElement('div');
                    depElement.className = 'departure';
                    const delayText = dep.delay > 0 ? `<div class="delay">+${dep.delay} min</div>` : '';
                    depElement.innerHTML = `<div class="line">${dep.line}</div><div class="time">${dep.when}</div>${delayText}<div class="direction">${dep.direction}</div>`;
                    listElement.appendChild(depElement);
                });
            } catch (error) {
                listElement.innerHTML = `<p>Fehler bei ${stationName}.</p>`;
            }
        }

        async function fetchAndDisplayEvents() {
            try {
                const response = await fetch(CLOUDFLARE_WORKER_URL);
                if (!response.ok) throw new Error('Netzwerkfehler');
                const events = await response.json();
                calendarDashboard.innerHTML = ''; const eventsByDate = {};
                events.forEach(event => { const eventDate = new Date(event.start.dateTime || event.start.date); const dateKey = eventDate.toISOString().split('T')[0]; if (!eventsByDate[dateKey]) { eventsByDate[dateKey] = []; } eventsByDate[dateKey].push(event); });
                const today = new Date();
                for (let i = 0; i < 30; i++) {
                    const currentDay = new Date(); currentDay.setDate(today.getDate() + i); const dateKey = currentDay.toISOString().split('T')[0];
                    if (eventsByDate[dateKey]) {
                        eventsByDate[dateKey].forEach(event => {
                            const card = document.createElement('div'); card.className = 'event-card'; const bgColor = colorMap[event.calendarName] || colorMap['default']; card.style.backgroundColor = bgColor; const textColor = getContrastColor(bgColor); card.style.color = textColor; const startDate = new Date(event.start.dateTime || event.start.date); const dateStringShort = startDate.toLocaleDateString('de-DE', { weekday: 'short', day: 'numeric', month: 'numeric' }); const timeString = event.start.dateTime ? startDate.toLocaleTimeString('de-DE', { hour: '2-digit', minute: '2-digit' }) + ' Uhr' : 'Ganztägig';
                            card.innerHTML = `<div class="content"><h2>${event.summary || '(Kein Titel)'}</h2><p class="calendar-source">${event.calendarName}</p></div><div class="event-details"><div class="date">${dateStringShort}</div><div class="time">${timeString}</div></div>`;
                            calendarDashboard.appendChild(card);
                        });
                    } else { const emptyCard = document.createElement('div'); emptyCard.className = 'empty-day-card'; emptyCard.textContent = currentDay.toLocaleDateString('de-DE', { weekday: 'long', day: 'numeric', month: 'long' }); calendarDashboard.appendChild(emptyCard); }
                }
            } catch (error) { calendarDashboard.innerHTML = `<h2>Fehler: Kalenderdaten konnten nicht geladen werden.</h2>`; }
        }
        function getContrastColor(hexColor) { if (!hexColor) return '#1f2937'; const r = parseInt(hexColor.substr(1, 2), 16); const g = parseInt(hexColor.substr(3, 2), 16); const b = parseInt(hexColor.substr(5, 2), 16); const luminance = (0.299 * r + 0.587 * g + 0.114 * b) / 255; return luminance > 0.6 ? '#1f2937' : '#f9fafb'; }

        // --- START- UND REFRESH-LOGIK ---
        fetchAndDisplayEvents();
        fetchTransitData('900078201', 'departures-neukoelln', 'S+U Neukölln');
        fetchTransitData('900019404', 'departures-zeitzer', 'Zeitzer Str.');

        setInterval(fetchAndDisplayEvents, 60000);
        setInterval(() => {
            fetchTransitData('900078201', 'departures-neukoelln', 'S+U Neukölln');
            fetchTransitData('900019404', 'departures-zeitzer', 'Zeitzer Str.');
        }, 30000);
    </script>
</body>
</html>
