<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <title>Dashboard</title>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;700;900&display=swap');
        :root { --color-bg: #111827; --color-text-dark: #1f2937; --color-text-light: #f9fafb; }
        html, body { margin: 0; padding: 0; width: 100%; height: 100%; overflow: hidden; position: fixed; }
        body { font-family: 'Inter', -apple-system, sans-serif; background-color: var(--color-bg); color: var(--color-text-light); display: flex; flex-direction: column; }
        
        #transit-widget {
            padding: 12px 16px; background-color: #1f2937; flex-shrink: 0;
            box-shadow: 0 4px 10px rgba(0,0,0,0.3); border-bottom: 1px solid #374151;
            max-height: 200px; /* ETWAS HÖHER FÜR MEHR EINTRÄGE */
            overflow-y: auto; -webkit-overflow-scrolling: touch;
        }
        .departure-row {
            display: flex; align-items: center; gap: 8px; font-size: 14px; padding: 5px 0;
        }
        .line-icon { display: flex; align-items: center; justify-content: center; min-width: 24px; }
        .line-icon svg { width: 18px; height: 18px; }
        .departure-row .time-info { white-space: nowrap; font-weight: 700; font-size: 15px; }
        .departure-row .line { font-weight: 900; font-size: 16px; min-width: 40px; text-align: left; }
        .departure-row .direction { font-size: 16px; font-weight: 700; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; flex-grow: 1; }
        .departure-row .station { font-size: 14px; font-weight: 900; margin-left: auto; padding-left: 10px; }
        .station-nk { color: #81a1c1; } /* DESATURIERTES BLAU */
        .station-sa { color: #a3be8c; } /* DESATURIERTES GRÜN */
        .delay { color: #fecaca; font-size: 12px; }

        #calendar-dashboard {
            padding: 16px 0; /* KEIN SEITLICHES PADDING MEHR */
            display: grid; grid-template-columns: 1fr; gap: 12px;
            flex-grow: 1; overflow-y: auto; -webkit-overflow-scrolling: touch;
        }
        .event-card, .empty-day-card {
            margin: 0; /* KEIN SEITLICHER ABSTAND MEHR */
            border-radius: 24px;
            padding: 12px 20px; /* SCHMALER */
        }
        .event-card {
            display: flex; align-items: center; justify-content: space-between; /* ZWEISPALTIGES LAYOUT */
            color: var(--color-text-dark); box-shadow: 0 4px 15px rgba(0,0,0,0.2);
        }
        .event-card .info { text-align: left; }
        .event-card .datetime { text-align: right; }
        .event-card h2 { margin: 0; font-size: 18px; line-height: 1.2; }
        .calendar-source { font-size: 11px; margin-top: 6px; padding: 3px 6px; border-radius: 6px; background-color: rgba(0,0,0,0.1); display: inline-block; }
        .event-details .time { font-size: 14px; font-weight: 400; }
        .event-details .date { font-size: 20px; font-weight: 900; }
        .empty-day-card { background-color: #1f2937; color: #9ca3af; text-align: center; font-weight: 700; font-size: 14px; padding: 8px; }
    </style>
</head>
<body>
    <div id="transit-widget"></div>
    <div id="calendar-dashboard"><h2>Lade Kalenderdaten...</h2></div>

    <script>
        const CLOUDFLARE_WORKER_URL = 'https://mkscal.ikeakatalog.workers.dev/';
        const calendarDashboard = document.getElementById('calendar-dashboard');
        const transitWidget = document.getElementById('transit-widget');
        const colorMap = { 'M&M': '#f4da63', 'Maria': '#d3d3d3', 'MK Solo': '#6dada9', 'Bodo Banali': '#6dada9', 'default': '#e5e7eb' };

        // NEU: Helfer-Funktion für die Icons
        function getTransitIcon(product) {
            switch(product) {
                case 'suburban': // S-Bahn
                    return `<svg viewBox="0 0 512 512" fill="#008000"><path d="M256 0C114.6 0 0 114.6 0 256s114.6 256 256 256 256-114.6 256-256S397.4 0 256 0zM128 384c-17.7 0-32-14.3-32-32s14.3-32 32-32 32 14.3 32 32-14.3 32-32 32zm192 0c-17.7 0-32-14.3-32-32s14.3-32 32-32 32 14.3 32 32-14.3 32-32 32zm88-160H104c-13.3 0-24-10.7-24-24V128c0-13.3 10.7-24 24-24h304c13.3 0 24 10.7 24 24v72c0 13.3-10.7 24-24 24z"/></svg>`;
                case 'subway': // U-Bahn
                    return `<svg viewBox="0 0 512 512" fill="#000080"><path d="M256 0C114.6 0 0 114.6 0 256s114.6 256 256 256 256-114.6 256-256S397.4 0 256 0zM128 384c-17.7 0-32-14.3-32-32s14.3-32 32-32 32 14.3 32 32-14.3 32-32 32zm192 0c-17.7 0-32-14.3-32-32s14.3-32 32-32 32 14.3 32 32-14.3 32-32 32zm88-160H104c-13.3 0-24-10.7-24-24V128c0-13.3 10.7-24 24-24h304c13.3 0 24 10.7 24 24v72c0 13.3-10.7 24-24 24z"/></svg>`;
                case 'bus':
                    return `<svg viewBox="0 0 512 512" fill="#800080"><path d="M128 384c-17.7 0-32-14.3-32-32s14.3-32 32-32 32 14.3 32 32-14.3 32-32 32zm256 0c-17.7 0-32-14.3-32-32s14.3-32 32-32 32 14.3 32 32-14.3 32-32 32zM80 128c0-17.7 14.3-32 32-32h288c17.7 0 32 14.3 32 32v128H80V128zm0 160h352v-32H80v32z"/></svg>`;
                default:
                    return ''; // Kein Icon für andere Typen
            }
        }
        
        async function fetchTransitData() {
            try {
                const response = await fetch(CLOUDFLARE_WORKER_URL + 'transit');
                if (!response.ok) throw new Error('Netzwerkfehler');
                const departures = await response.json();
                
                transitWidget.innerHTML = '';
                if (!departures || departures.length === 0) {
                    transitWidget.innerHTML = '<p style="text-align: center; color: #9ca3af;">Keine Abfahrten gefunden.</p>'; return;
                }
                departures.slice(0, 10).forEach(dep => { // Zeige die nächsten 10
                    const depElement = document.createElement('div');
                    depElement.className = 'departure-row';
                    
                    const now = new Date();
                    const departureTime = new Date(dep.when);
                    const minutesFromNow = Math.round((departureTime - now) / 60000);
                    
                    const timeInfo = `${departureTime.toLocaleTimeString('de-DE', { hour: '2-digit', minute: '2-digit' })} <span style="color: #9ca3af;">(in ${minutesFromNow} Min)</span>`;
                    const delayText = dep.delay > 0 ? ` <span class="delay">+${dep.delay}</span>` : '';

                    depElement.innerHTML = `
                        <div class="line-icon">${getTransitIcon(dep.product)}</div>
                        <div class="line">${dep.line}</div>
                        <div class="time-info">${timeInfo}${delayText}</div>
                        <div class="direction">nach ${dep.direction}</div>
                        <div class="station station-${dep.station.toLowerCase()}">(${dep.station})</div>
                    `;
                    transitWidget.appendChild(depElement);
                });
            } catch (error) {
                transitWidget.innerHTML = '<p style="text-align: center; color: #9ca3af;">Fehler beim Laden der Abfahrten.</p>';
            }
        }

        async function fetchAndDisplayEvents() {
            try {
                const response = await fetch(CLOUDFLARE_WORKER_URL);
                if (!response.ok) throw new Error('Netzwerkfehler');
                const events = await response.json();
                calendarDashboard.innerHTML = ''; const eventsByDate = {};
                events.forEach(event => { const d = new Date(event.start.dateTime || event.start.date); const key = new Date(d.getFullYear(), d.getMonth(), d.getDate()).toISOString(); if (!eventsByDate[key]) { eventsByDate[key] = []; } eventsByDate[key].push(event); });
                const today = new Date(); today.setHours(0,0,0,0);
                const tomorrow = new Date(today); tomorrow.setDate(today.getDate() + 1);
                for (let i = 0; i < 30; i++) {
                    const currentDay = new Date(today); currentDay.setDate(today.getDate() + i);
                    const dateKey = currentDay.toISOString();
                    if (eventsByDate[dateKey]) {
                        eventsByDate[dateKey].forEach(event => {
                            const card = document.createElement('div'); card.className = 'event-card'; const bgColor = colorMap[event.calendarName] || colorMap['default']; card.style.backgroundColor = bgColor; const textColor = getContrastColor(bgColor); card.style.color = textColor; const startDate = new Date(event.start.dateTime || event.start.date);
                            let dateDisplayString;
                            if (currentDay.getTime() === today.getTime()) { dateDisplayString = 'Heute'; } 
                            else if (currentDay.getTime() === tomorrow.getTime()) { dateDisplayString = 'Morgen'; } 
                            else { dateDisplayString = startDate.toLocaleDateString('de-DE', { weekday: 'short', day: 'numeric', month: 'numeric' }); }
                            const timeString = event.start.dateTime ? startDate.toLocaleTimeString('de-DE', { hour: '2-digit', minute: '2-digit' }) + ' Uhr' : 'Ganztägig';
                            
                            // NEUES KARTEN-LAYOUT
                            card.innerHTML = `
                                <div class="info">
                                    <h2>${event.summary || '(Kein Titel)'}</h2>
                                    <p class="calendar-source">${event.calendarName}</p>
                                </div>
                                <div class="datetime">
                                    <div class="date">${dateDisplayString}</div>
                                    <div class="time">${timeString}</div>
                                </div>
                            `;
                            calendarDashboard.appendChild(card);
                        });
                    } else { const emptyCard = document.createElement('div'); emptyCard.className = 'empty-day-card'; emptyCard.textContent = currentDay.toLocaleDateString('de-DE', { weekday: 'long', day: 'numeric', month: 'long' }); calendarDashboard.appendChild(emptyCard); }
                }
            } catch (error) { calendarDashboard.innerHTML = `<h2>Fehler: Kalenderdaten konnten nicht geladen werden.</h2>`; }
        }
        function getContrastColor(hexColor) { if (!hexColor) return '#1f2937'; const r = parseInt(hexColor.substr(1, 2), 16); const g = parseInt(hexColor.substr(3, 2), 16); const b = parseInt(hexColor.substr(5, 2), 16); const luminance = (0.299 * r + 0.587 * g + 0.114 * b) / 255; return luminance > 0.6 ? '#1f2937' : '#f9fafb'; }

        fetchAndDisplayEvents();
        fetchTransitData();
        setInterval(fetchAndDisplayEvents, 60000);
        setInterval(fetchTransitData, 30000);
    </script>
</body>
</html>
